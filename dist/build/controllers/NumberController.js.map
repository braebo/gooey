{"version":3,"file":"NumberController.js","sources":["../../../../src/controllers/NumberController.ts"],"sourcesContent":["import type { InputOptions, ValidInput } from '../inputs/Input'\nimport type { Tooltip } from '../shared/Tooltip'\n\nimport { modIcon, modKey } from '../shared/keys'\nimport { getStyle } from '../shared/getStyle'\nimport { create } from '../shared/create'\nimport { Logger } from '../shared/logger'\n\nexport class NumberController<\n\tTInput extends ValidInput = ValidInput,\n\tTOptions extends InputOptions<any> = InputOptions,\n> {\n\telement: HTMLInputElement & { tooltip: Tooltip }\n\n\tdragEnabled = false\n\tdragging = false\n\thovering = false\n\tdelta = 0\n\n\tprivate _log: Logger\n\n\tconstructor(\n\t\tpublic input: TInput,\n\t\tpublic opts: TOptions,\n\t\tpublic parent?: HTMLElement,\n\t) {\n\t\tthis._log = new Logger(`NumberController ${this.input.title}`, { fg: 'darkgoldenrod' })\n\n\t\tthis.element = create('input', {\n\t\t\ttype: 'number',\n\t\t\tclasses: ['gooey-controller', 'gooey-controller-number'],\n\t\t\tvalue: String(input.state.value),\n\t\t\tparent,\n\t\t\ttooltip: {\n\t\t\t\ttext: /*html*/ `Hold <span class=\"gooey-hotkey\">${modIcon()}</span> to drag`,\n\t\t\t\tplacement: 'top',\n\t\t\t\tdelay: 1250,\n\t\t\t\t// @ts-expect-error - @internal\n\t\t\t\tstyle: input.folder.gooey?._getStyles,\n\t\t\t},\n\t\t})\n\n\t\tif ('step' in opts) {\n\t\t\tthis.element.step = String(opts.step)\n\t\t}\n\n\t\tinput.listen(this.element, 'pointerenter', this.hoverStart)\n\t}\n\n\thoverStart = (e: PointerEvent) => {\n\t\tthis._log.fn('hoverStart').debug(e)\n\t\tthis.hovering = true\n\t\tthis.element.classList.add('hovering')\n\n\t\tthis.maybeEnableDrag(e)\n\n\t\tthis.element.removeEventListener('pointerleave', this.hoverEnd)\n\t\tthis.element.addEventListener('pointerleave', this.hoverEnd)\n\t\tdocument.removeEventListener('keydown', this.maybeEnableDrag)\n\t\tdocument.addEventListener('keydown', this.maybeEnableDrag)\n\t}\n\n\thoverEnd = (e: PointerEvent) => {\n\t\tthis._log.fn('hoverEnd').debug(e)\n\t\tthis.hovering = false\n\t\tthis.element.classList.remove('hovering')\n\n\t\tthis.cancelDrag(e)\n\n\t\tthis.element.removeEventListener('pointerleave', this.hoverEnd)\n\t\tdocument.removeEventListener('keydown', this.maybeEnableDrag)\n\t}\n\n\tdragKeyHeld = (e: KeyboardEvent | PointerEvent) => {\n\t\treturn modKey(e)\n\t}\n\n\tcancelDrag = (e: KeyboardEvent | PointerEvent) => {\n\t\tthis._log.fn('cancelDrag').debug(e)\n\t\tthis.dragEnabled = e.type === 'keyup' ? this.dragKeyHeld(e) : false\n\n\t\tdocument.removeEventListener('keyup', this.cancelDrag)\n\t\tthis.element.removeEventListener('pointerleave', this.cancelDrag)\n\t\tthis.element.removeEventListener('pointerdown', this.maybeDragStart)\n\n\t\tif (!this.dragEnabled) {\n\t\t\tthis.element.style.cursor = this.element.dataset['cursor'] ?? 'text'\n\n\t\t\tif (this.dragging) {\n\t\t\t\tthis.dragEnd()\n\t\t\t}\n\t\t}\n\t}\n\n\tmaybeEnableDrag = (e: KeyboardEvent | PointerEvent) => {\n\t\tthis._log.fn('maybeEnableDrag').debug(e)\n\t\tif (this.dragKeyHeld(e)) {\n\t\t\tthis.dragEnabled = true\n\n\t\t\tdocument.removeEventListener('keyup', this.cancelDrag)\n\t\t\tdocument.addEventListener('keyup', this.cancelDrag)\n\n\t\t\tthis.element.removeEventListener('pointerleave', this.cancelDrag)\n\t\t\tthis.element.addEventListener('pointerleave', this.cancelDrag)\n\n\t\t\tthis.element.removeEventListener('pointerdown', this.maybeDragStart)\n\t\t\tthis.element.addEventListener('pointerdown', this.maybeDragStart)\n\n\t\t\tthis.element.dataset['cursor'] = getStyle(this.element, 'cursor')\n\t\t\tthis.element.style.cursor = 'ns-resize'\n\t\t}\n\t}\n\n\tmaybeDragStart = () => {\n\t\tif (this.hovering && this.dragEnabled) {\n\t\t\tthis.dragStart()\n\t\t}\n\t}\n\n\tdragStart = async () => {\n\t\tthis._log.fn('dragStart').debug()\n\t\tthis.dragging = true\n\t\tthis.element.dispatchEvent(new Event('dragStart'))\n\n\t\tthis.element.tooltip.hide()\n\n\t\tthis.element.removeEventListener('pointermove', this.drag)\n\t\tthis.element.addEventListener('pointermove', this.drag)\n\n\t\tdocument.removeEventListener('pointerup', this.dragEnd)\n\t\tdocument.addEventListener('pointerup', this.dragEnd)\n\n\t\tthis.element.classList.add('dragging')\n\t\t// https://developer.mozilla.org/en-US/docs/Web/API/Element/requestPointerLock#browser_compatibility\n\t\tawait this.element.requestPointerLock()\n\t\tthis.element.blur()\n\t}\n\n\tdragEnd = () => {\n\t\tthis._log.fn('dragEnd').debug()\n\t\tthis.dragging = false\n\n\t\tthis.element.classList.remove('dragging')\n\n\t\tthis.element.removeEventListener('pointermove', this.drag)\n\t\tdocument.removeEventListener('pointerup', this.dragEnd)\n\n\t\tdocument.exitPointerLock()\n\n\t\tthis.element.dispatchEvent(new Event('dragEnd'))\n\t}\n\n\tdrag = (e: PointerEvent) => {\n\t\tif (!this.dragging) return\n\n\t\tconst multiplier = e.shiftKey ? 4 : e.altKey ? 0.1 : 1\n\n\t\tconst direction = Math.sign(e.movementY)\n\t\tthis.delta += Math.abs(e.movementY)\n\n\t\tif (this.delta > +this.element.step) {\n\t\t\tconst amount = +this.element.step * multiplier * -direction\n\n\t\t\tthis.element.value = String(this.element.valueAsNumber + amount)\n\n\t\t\tdirection === -1\n\t\t\t\t? this.element.stepUp(+this.element.step * multiplier)\n\t\t\t\t: this.element.stepDown(+this.element.step * multiplier)\n\n\t\t\tthis.delta = 0\n\t\t\tthis.element.dispatchEvent(new Event('input'))\n\t\t}\n\t}\n\n\tdispose() {\n\t\tthis.element.removeEventListener('pointerenter', this.hoverStart)\n\t\tthis.element.removeEventListener('pointerleave', this.hoverEnd)\n\t\tthis.element.removeEventListener('pointermove', this.drag)\n\t\tdocument.removeEventListener('keydown', this.maybeEnableDrag)\n\t\tdocument.removeEventListener('keyup', this.cancelDrag)\n\t\tthis.element.removeEventListener('pointerleave', this.cancelDrag)\n\t\tthis.element.removeEventListener('pointerdown', this.maybeDragStart)\n\t\tdocument.removeEventListener('pointerup', this.dragEnd)\n\t\tthis.element.tooltip.dispose()\n\t\tthis.element.remove()\n\t}\n}\n"],"names":[],"mappings":"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"}