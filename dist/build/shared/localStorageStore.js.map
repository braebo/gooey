{"version":3,"file":"localStorageStore.js","sources":["../../../../src/shared/localStorageStore.ts"],"sourcesContent":["// https://github.com/babichjacob/svelte-localstorage\n\nimport { writable, type Writable } from './store'\nimport { cancelDefer, defer } from './defer'\n\nexport interface StateOptions<T> extends Partial<Writable<T>> {\n\t/**\n\t * If provided, localStorage updates will be debounced by\n\t * the specified number of milliseconds. If both `debounce`\n\t * and `throttle` are provided, `debounce` will take precedence.\n\t * @default undefined\n\t */\n\tdebounce?: number\n\t/**\n\t * If true, localStorage updates will be deferred using\n\t * {@link https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback | requestIdleCallback},\n\t * falling back to `requestAnimationFrame` and finally `setTimeout` with\n\t * a timeout of 0. Particularly useful in hot code paths like render loops.\n\t * @remarks\n\t * Deferring can significantly reduce the performance impact of many syncronous localStorage\n\t * updates running on the main thread. At the time of writing, `requestIdleCallback` is still\n\t * in Safari Technology Preview, hence the fallbacks.\n\t * @default false\n\t */\n\tdefer?: boolean\n\t/**\n\t * Optional callback function that runs after the store is\n\t * updated and all subscribers have been notified.\n\t * @default undefined\n\t */\n\tonChange?: (v: T) => void\n\n\t/**\n\t * Log errors to the console.\n\t * @default import.meta.env.DEV\n\t */\n\tverbose?: boolean\n\n\t/**\n\t * Used for testing.\n\t * @default false\n\t * @internal\n\t */\n\tbrowserOverride?: boolean\n}\n\n/**\n * An observable store that uses localStorage to store data asyncronously.\n * It supports Maps and Sets, debouncing and deferring localStorage updates,\n * and syncronizes with localStorage events across tabs.\n * @param key - The key to store the data under.\n * @param initial - The initial value of the store.\n * @param options - {@link StateOptions}\n * @example\n * ```ts\n * const store = localStorageStore('foo', 5)\n * ```\n */\nexport const localStorageStore = <T>(\n\tkey: string,\n\tinitial: T,\n\toptions?: StateOptions<T>,\n): Writable<T> => {\n\tlet currentValue = initial\n\tconst verbose = !!options?.verbose\n\n\tconst { set: setStore, ...readableStore } = writable<T>(initial, () => {\n\t\tif (options?.browserOverride || typeof globalThis.window !== 'undefined') {\n\t\t\tgetAndSetFromLocalStorage()\n\n\t\t\tconst updateFromStorageEvents = (event: StorageEvent) => {\n\t\t\t\tif (event.key === key) getAndSetFromLocalStorage()\n\t\t\t}\n\n\t\t\twindow.addEventListener('storage', updateFromStorageEvents)\n\n\t\t\treturn () => window.removeEventListener('storage', updateFromStorageEvents)\n\t\t} else return () => {}\n\t})\n\n\tlet serialize = JSON.stringify\n\tlet deserialize = JSON.parse\n\n\tconst type = initial instanceof Map ? 'Map' : initial instanceof Set ? 'Set' : ''\n\tconst isMapOrSet = ['Map', 'Set'].includes(type)\n\n\tif (isMapOrSet) {\n\t\tserialize = (value: T) => JSON.stringify(Array.from((value as Map<any, any>).entries()))\n\t\tdeserialize = (value: string) => {\n\t\t\tconst parsed = JSON.parse(value)\n\t\t\tif (Array.isArray(parsed)) {\n\t\t\t\tif (initial instanceof Map) return new Map(parsed)\n\t\t\t\tif (initial instanceof Set) return new Set(parsed)\n\t\t\t\treturn parsed\n\t\t\t}\n\t\t\t// prettier-ignore\n\t\t\tif (verbose) console.error(`Failed to deserialize ${type} from localStorageStore:`, { parsed, value, initial, key, options })\n\t\t\treturn value\n\t\t}\n\t}\n\n\tconst set = (value: T) => {\n\t\tcurrentValue = value\n\t\tif (typeof value === 'string' && value.startsWith('\"') && value.endsWith('\"')) {\n\t\t\tvalue = deserialize(value)\n\t\t}\n\t\tsetStore(value)\n\t\tsetItem(value)\n\t\toptions?.onChange?.(value)\n\t}\n\n\tlet setItem = (value: T) => {\n\t\ttry {\n\t\t\tvalue = serialize(value) as T\n\t\t\tlocalStorage.setItem(key, value as string)\n\t\t} catch (error) {\n\t\t\tif (verbose)\n\t\t\t\tconsole.error(`Failed to set localStorageStore value:`, { error, key, value })\n\t\t}\n\t}\n\n\tif (options?.defer) {\n\t\tlet setDeferId: number\n\t\tconst _ = setItem\n\t\tsetItem = (value: T) => {\n\t\t\tcancelDefer(setDeferId)\n\t\t\tsetDeferId = defer(() => {\n\t\t\t\t_(value)\n\t\t\t}) as number\n\t\t}\n\t}\n\n\tif (options?.debounce) {\n\t\tlet timeout = (setTimeout as Window['setTimeout']) ?? (() => void 0)\n\t\tlet timeoutId: number\n\t\tconst _ = setItem\n\t\tsetItem = (value: T) => {\n\t\t\tclearTimeout(timeoutId)\n\t\t\ttimeoutId = timeout(() => {\n\t\t\t\t_(value)\n\t\t\t}, options.debounce)\n\t\t}\n\t}\n\n\tconst getAndSetFromLocalStorage = () => {\n\t\tlet localValue: string | null = null\n\n\t\tlocalValue = localStorage.getItem(key) ?? null\n\n\t\tif (localValue === null) {\n\t\t\tset(initial)\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tconst parsed = deserialize(localValue)\n\t\t\t\tsetStore(parsed as T)\n\t\t\t\tcurrentValue = parsed as T\n\t\t\t} catch (e) {\n\t\t\t\tif (verbose) {\n\t\t\t\t\tconsole.error(`Failed to parse localStorageStore value:`, { key, localValue })\n\t\t\t\t\tconsole.error(e)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tconst update = (fn: (T: T) => T) => {\n\t\tset(fn(currentValue))\n\t}\n\n\treturn { ...readableStore, set, update }\n}\n"],"names":[],"mappings":"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"}